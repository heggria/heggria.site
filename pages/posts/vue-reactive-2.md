---
title: Vue åŸç†ï¼šå“åº”å¼ç¼–ç¨‹ï¼ˆäºŒï¼‰
date: 2024-10-17T16:00:00.000+00:00
duration: 15min
---

[[toc]]

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ·±å…¥äº†è§£ Vue çš„å“åº”å¼ç¼–ç¨‹åŸç†ã€‚ä¸‹æ–‡çš†ä»¥ [`@vue/reactivity@3.5.12`](https://github.com/vuejs/core/tree/main/packages/reactivity/src) åŒ…æºç ä½œä¸ºå‚è€ƒã€‚

# æ–‡ä»¶ç»“æ„

ä¸‹é¢åˆ—å‡º `packages/reactivity/src` çš„æ–‡ä»¶åˆ—è¡¨ï¼Œï¼Œå¹¶å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œç®€å•çš„åˆ†ç±»ï¼Œå¯ä»¥çœ‹åˆ°ç»„æˆéå¸¸ç®€å•ï¼Œä¸€å…±å°± 13 files + 2539 codesï¼š

- å“åº”å¼åŸºç¡€

  - `baseHandlers.ts`ï¼šåŸºç¡€çš„å“åº”å¼å¤„ç†
  - `dep.ts`ï¼šä¾èµ–çš„å¤„ç†
  - `effect.ts`ï¼šå‰¯ä½œç”¨çš„å¤„ç†
  - `effectScope.ts`ï¼šå‰¯ä½œç”¨çš„ä½œç”¨åŸŸ

- ç‰¹æ®Šå“åº”å¼å¯¹è±¡å¤„ç†

  - `arrayInstrumentations.ts`ï¼šæ•°ç»„çš„å“åº”å¼å¤„ç†
  - `collectionHandlers.ts`ï¼šé›†åˆçš„å“åº”å¼å¤„ç†

- å“åº”å¼ API

  - `reactive.ts`ï¼šå“åº”å¼çš„å¤„ç†
  - `ref.ts`ï¼šå¼•ç”¨çš„å¤„ç†
  - `computed.ts`ï¼šè®¡ç®—å±æ€§çš„å¤„ç†
  - `watch.ts`ï¼šç›‘å¬çš„å¤„ç†

- å·¥å…·æ–‡ä»¶

  - `constants.ts`ï¼šå¸¸é‡
  - `index.ts`ï¼šå…¥å£æ–‡ä»¶
  - `warning.ts`ï¼šè­¦å‘Šçš„å¤„ç†

åœ¨æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬é‡ç‚¹ç ”ç©¶å“åº”å¼åŸºç¡€éƒ¨åˆ†çš„æºç ã€‚

# effectScope.ts

> åœ¨Vueçš„å“åº”å¼ç³»ç»Ÿä¸­ï¼Œå‰¯ä½œç”¨æ˜¯æŒ‡é‚£äº›æ ¹æ®å“åº”å¼çŠ¶æ€å˜åŒ–è€Œè‡ªåŠ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œå¦‚è®¡ç®—å±æ€§ï¼ˆcomputedï¼‰å’Œä¾¦å¬å™¨ï¼ˆwatchersï¼‰ã€‚

**`EffectScope`** ç±»æ˜¯ vue å“åº”å¼çš„åŸºçŸ³ï¼Œæä¾›äº†ä¸€ç§æ–¹å¼æ¥ç»„ç»‡å“åº”å¼å‰¯ä½œç”¨ã€‚**`EffectScope`** è®©ä½ èƒ½å¤Ÿæ‰¹é‡æ§åˆ¶å‰¯ä½œç”¨çš„æ¿€æ´»å’Œåœæ­¢ã€‚è¿™å¯¹äºåœ¨ç»„ä»¶å¸è½½æ—¶æ¸…ç†å‰¯ä½œç”¨ç‰¹åˆ«æœ‰ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ **`EffectScope`** ç±»çš„è®¾è®¡ï¼š

```tsx
// å…¨å±€å”¯ä¸€çš„æ´»åŠ¨ä½œç”¨åŸŸ
let activeEffectScope: EffectScope | undefined

export class EffectScope {
  // æ˜¯å¦ä¸ºæ¿€æ´»æ€
  private _active = true
  // å‰¯ä½œç”¨
  effects: ReactiveEffect[] = []
  // æ¸…ç†å‡½æ•°
  cleanups: (() => void)[] = []
  // æ˜¯å¦æš‚åœ
  private _isPaused = false
  // çˆ¶ä½œç”¨åŸŸ
  parent: EffectScope | undefined
  // å­ä½œç”¨åŸŸ
  scopes: EffectScope[] | undefined
  // åœ¨çˆ¶ä½œç”¨åŸŸçš„ scopes çš„ index
  private index: number | undefined

  // æ„é€ å‡½æ•°ï¼Œå¯ä»¥å£°æ˜æ˜¯å¦ç‹¬ç«‹äº activeEffectScope
  constructor(public detached = false) {}
  get active()
  pause()
  resume()
  run<T>(fn: () => T): T | undefined
  on()
  off()
  stop(fromParent?: boolean)
}

// å·¥å‚å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ effectScope å®ä¾‹
export function effectScope(detached?: boolean)

// è·å– activeEffectScope
export function getCurrentScope()

// åœ¨å½“å‰æ¿€æ´»çš„EffectScopeä¸Šæ³¨å†Œä¸€ä¸ªæ¸…ç†å›è°ƒï¼Œè¯¥å›è°ƒä¼šåœ¨Scopeåœæ­¢æ—¶è¢«è°ƒç”¨
export function onScopeDispose(fn: () => void)
```

## constructor æ„é€ å‡½æ•°

> ğŸ’¡ æ¥æ”¶ä¸€ä¸ª **`detached`** å‚æ•°ï¼Œç”¨äºå†³å®šæ–°å»ºçš„EffectScopeæ˜¯å¦ç‹¬ç«‹äºå½“å‰æ¿€æ´»çš„EffectScopeã€‚å¦‚æœä¸æ˜¯ç‹¬ç«‹çš„ï¼Œå°†å½“å‰çš„ **`EffectScope`** å®ä¾‹ï¼ˆå³ **`this`** ï¼‰æ·»åŠ åˆ°çˆ¶ä½œç”¨åŸŸï¼ˆ**`activeEffectScope`**ï¼‰çš„å­ä½œç”¨åŸŸåˆ—è¡¨ï¼ˆ**`scopes`**ï¼‰ä¸­ï¼Œå¹¶è®°å½•å½“å‰å®ä¾‹åœ¨çˆ¶ä½œç”¨åŸŸå­ä½œç”¨åŸŸåˆ—è¡¨ä¸­çš„ä½ç½®ï¼ˆç´¢å¼•ï¼‰ã€‚

æˆ‘ä»¬å…ˆæ¥äº†è§£ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸï¼šå½“æˆ‘ä»¬è°ˆè®ºæ´»åŠ¨ä½œç”¨åŸŸï¼ˆactiveEffectScopeï¼‰å’Œå­ä½œç”¨åŸŸï¼ˆsub-scopesï¼‰æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºä¸€ç§å±‚çº§ç»“æ„æˆ–**ä½œç”¨åŸŸæ ‘**ï¼Œè¿™åœ¨Vueçš„å“åº”å¼ç³»ç»Ÿä¸­ç”¨äºç®¡ç†å‰¯ä½œç”¨ï¼ˆå¦‚è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨ï¼‰ã€‚

1. **æ´»åŠ¨ä½œç”¨åŸŸï¼ˆActive Effect Scopeï¼‰**ï¼š
   æ´»åŠ¨ä½œç”¨åŸŸæ˜¯å½“å‰æ­£åœ¨è¢«Vueå“åº”å¼ç³»ç»Ÿè·Ÿè¸ªçš„ä½œç”¨åŸŸã€‚**åœ¨ä»»ä½•ç»™å®šæ—¶é—´ç‚¹ï¼Œåªæœ‰ä¸€ä¸ªæ´»åŠ¨ä½œç”¨åŸŸï¼ˆå…¨å±€å”¯ä¸€å®ä¾‹ï¼Œä½¿ç”¨ let å£°æ˜ï¼‰ã€‚**è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç å—æˆ–ç¯å¢ƒã€‚å½“ä½ åˆ›å»ºæ–°çš„å“åº”å¼å‰¯ä½œç”¨æ—¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªè®¡ç®—å±æ€§æˆ–ä¾¦å¬å™¨ï¼‰ï¼Œå®ƒä¼šè‡ªåŠ¨**æ³¨å†Œ**åˆ°å½“å‰çš„æ´»åŠ¨ä½œç”¨åŸŸã€‚è¿™æ„å‘³ç€è¿™ä¸ªå‰¯ä½œç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆæ¯”å¦‚ï¼Œå®ƒçš„æ¿€æ´»å’Œåœæ­¢ï¼‰å—åˆ°æ‰€å±ä½œç”¨åŸŸçš„æ§åˆ¶ã€‚
2. **å­ä½œç”¨åŸŸï¼ˆSub-scopesï¼‰**ï¼š
   å­ä½œç”¨åŸŸæ˜¯ä»å¦ä¸€ä¸ªä½œç”¨åŸŸï¼ˆçˆ¶ä½œç”¨åŸŸï¼‰ä¸­åˆ›å»ºçš„ä½œç”¨åŸŸã€‚å®ƒç»§æ‰¿äº†çˆ¶ä½œç”¨åŸŸçš„ä¸€äº›ç‰¹æ€§ï¼Œæ¯”å¦‚å‰¯ä½œç”¨çš„ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¯ä»¥ç‹¬ç«‹äºçˆ¶ä½œç”¨åŸŸè¿›è¡Œæ“ä½œã€‚å­ä½œç”¨åŸŸå…è®¸å°†å‰¯ä½œç”¨æŒ‰é€»è¾‘æˆ–åŠŸèƒ½ç»„ç»‡æˆä¸åŒçš„ç»„ï¼Œæ¯ä¸ªç»„å¯ä»¥å•ç‹¬ç®¡ç†ã€‚

![æˆªå±2024-03-19 15.40.45.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1d9c552afc64699a7cef49ff3da4520~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=842&h=424&s=158036&e=png&b=f9f9f9)

è¿™ç§è®¾è®¡ä½¿å¾—Vueçš„å“åº”å¼ç³»ç»Ÿèƒ½å¤ŸæŒ‰ç…§ä¸€ç§ç»“æ„åŒ–çš„æ–¹å¼æ¥ç®¡ç†å‰¯ä½œç”¨ï¼Œæé«˜äº†å‰¯ä½œç”¨ç®¡ç†çš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚å…·ä½“æ¥è¯´ï¼š

- **å±‚çº§ç®¡ç†**ï¼šé€šè¿‡æ´»åŠ¨ä½œç”¨åŸŸå’Œå­ä½œç”¨åŸŸçš„å±‚çº§ç»“æ„ï¼Œå¯ä»¥ç²¾ç»†åœ°æ§åˆ¶å‰¯ä½œç”¨çš„æ¿€æ´»å’Œåœæ­¢ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œæ‰€æœ‰å±äºè¯¥ç»„ä»¶ï¼ˆåŠå…¶å­ç»„ä»¶ï¼‰çš„å‰¯ä½œç”¨å¯ä»¥é€šè¿‡åœæ­¢ç›¸åº”çš„ä½œç”¨åŸŸæ¥ä¸€æ¬¡æ€§æ¸…ç†ï¼Œä»è€Œé¿å…å†…å­˜æ³„éœ²ã€‚
- **ä½œç”¨åŸŸéš”ç¦»**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºä¸å½“å‰æ´»åŠ¨ä½œç”¨åŸŸç‹¬ç«‹çš„ä½œç”¨åŸŸï¼ˆé€šè¿‡ä¼ é€’ **`detached`** å‚æ•°ï¼‰ã€‚è¿™ç§éš”ç¦»å¯ä»¥ç”¨äºç‰¹æ®Šåœºæ™¯ï¼Œæ¯”å¦‚è·¨ç»„ä»¶å…±äº«çš„å“åº”å¼çŠ¶æ€ï¼Œæˆ–è€…åœ¨æŸäº›éœ€è¦é•¿æœŸå­˜åœ¨çš„å‰¯ä½œç”¨ä¸­ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸä¸åº”è¯¥è¢«å½“å‰ç»„ä»¶çš„é”€æ¯æ‰€å½±å“ã€‚

å…è®¸å¼€å‘è€…åœ¨éœ€è¦çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªä¸å½“å‰æ´»åŠ¨ä½œç”¨åŸŸï¼ˆactiveEffectScopeï¼‰ç‹¬ç«‹çš„æ–°ä½œç”¨åŸŸï¼ˆEffectScopeï¼‰ï¼Œæˆ–è€…å°†æ–°ä½œç”¨åŸŸä½œä¸ºå½“å‰æ´»åŠ¨ä½œç”¨åŸŸçš„å­ä½œç”¨åŸŸã€‚è¿™ç§è®¾è®¡æœ‰å‡ ä¸ªå…³é”®å¥½å¤„ï¼š

1. **æ¨¡å—åŒ–å’Œç»„ç»‡æ€§**ï¼šé€šè¿‡å…è®¸æ–°çš„EffectScopeä½œä¸ºå½“å‰æ´»åŠ¨EffectScopeçš„å­ä½œç”¨åŸŸï¼ŒVueæä¾›äº†ä¸€ç§è‡ªç„¶çš„æ–¹å¼æ¥æ¨¡å—åŒ–å’Œç»„ç»‡å‰¯ä½œç”¨ã€‚è¿™å¯¹äºç»´æŠ¤å¤§å‹åº”ç”¨çš„çŠ¶æ€å’Œå‰¯ä½œç”¨ç‰¹åˆ«æœ‰ç”¨ï¼Œå¯ä»¥æ¸…æ™°åœ°å°†å‰¯ä½œç”¨ç»„ç»‡åœ¨ä¸åŒçš„ä½œç”¨åŸŸä¸­ï¼Œä¾¿äºç®¡ç†å’Œç†è§£ã€‚
2. **çµæ´»çš„å‰¯ä½œç”¨æ§åˆ¶**ï¼šæœ‰æ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›åˆ›å»ºä¸€ä¸ªå‰¯ä½œç”¨ä½œç”¨åŸŸï¼Œä½†ä¸å¸Œæœ›å®ƒä¸å½“å‰çš„æ´»åŠ¨ä½œç”¨åŸŸæœ‰ç›´æ¥å…³è”ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€äº›ç‹¬ç«‹çš„åº“æˆ–å·¥å…·å‡½æ•°ä¸­ä½¿ç”¨å‰¯ä½œç”¨æ—¶ï¼Œå¯èƒ½ä¸å¸Œæœ›å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸä¸å½“å‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç›´æ¥ç»‘å®šã€‚é€šè¿‡ **`detached`** å‚æ•°ï¼Œä½ å¯ä»¥çµæ´»åœ°æ§åˆ¶è¿™ä¸ªä½œç”¨åŸŸçš„ç‹¬ç«‹æ€§ï¼Œé¿å…ä¸å¿…è¦çš„ä¾èµ–ã€‚
3. **ç»†ç²’åº¦çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šåœ¨Vueåº”ç”¨ä¸­ï¼Œç»„ä»¶çš„æŒ‚è½½å’Œå¸è½½å¯èƒ½å¯¼è‡´å¤§é‡å‰¯ä½œç”¨çš„åˆ›å»ºå’Œé”€æ¯ã€‚å°†EffectScopeä¸ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç´§å¯†ç»‘å®šï¼Œå¯ä»¥åœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨åœæ­¢å…¶æ‰€æœ‰å‰¯ä½œç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚å¯¹äºé‚£äº›éœ€è¦è·¨ç»„ä»¶å…±äº«æˆ–è€…åœ¨ç»„ä»¶å¸è½½åä»éœ€ç»§ç»­å­˜åœ¨çš„å‰¯ä½œç”¨ï¼Œ**`detached`** å‚æ•°æä¾›äº†ä¸€ç§æ–¹å¼æ¥é˜²æ­¢è¿™äº›å‰¯ä½œç”¨è¢«è‡ªåŠ¨åœæ­¢ã€‚
4. **æ›´å¥½çš„æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé¿å…åˆ›å»ºä¸å¿…è¦çš„å­ä½œç”¨åŸŸå¯ä»¥å‡å°‘å†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›ä½œç”¨åŸŸä¼šé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çš„åœºæ™¯ä¸‹ã€‚**`detached`** å‚æ•°å…è®¸å¼€å‘è€…æ ¹æ®å…·ä½“æƒ…å†µå†³å®šæ˜¯å¦éœ€è¦è¿™æ ·çš„å­ä½œç”¨åŸŸã€‚

æ•´ä¸ªæœºåˆ¶æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥ç®¡ç†Vueåº”ç”¨ä¸­çš„å“åº”å¼å‰¯ä½œç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†å‰¯ä½œç”¨ï¼Œé¿å…å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚

## `active` æ¿€æ´»çŠ¶æ€

> ğŸ’¡ æ§åˆ¶å‰¯ä½œç”¨æ˜¯å¦å¯ä»¥è¢«æ‰§è¡Œï¼Œæ–¹æ³•åˆ†åˆ«ç”¨äºæ¿€æ´»å’Œåœæ­¢EffectScopeï¼Œæ”¹å˜å½“å‰æ¿€æ´»çš„Scopeã€‚

**`active`** å±æ€§æ ‡è¯†EffectScopeæ˜¯å¦æ¿€æ´»ï¼Œåªæœ‰æ¿€æ´»çŠ¶æ€çš„Scopeæ‰èƒ½è¿è¡Œå…¶ä¸­çš„å‰¯ä½œç”¨ã€‚ä¸ºäº†ç®¡ç†å’Œæ§åˆ¶Vueä¸­å“åº”å¼å‰¯ä½œç”¨ï¼ˆå¦‚è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨ï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¾‹å¦‚ï¼Œå½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°DOMçš„æ¸²æŸ“å‡½æ•°ã€‚é€šè¿‡EffectScopeçš„æ¿€æ´»çŠ¶æ€ï¼ŒVueå¯ä»¥ç²¾ç¡®åœ°æ§åˆ¶è¿™äº›å‰¯ä½œç”¨çš„æ¿€æ´»å’Œåœæ­¢ã€‚

åœ¨ç»„ä»¶å¸è½½æˆ–ä¸éœ€è¦å“åº”å¼æ›´æ–°çš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥é€šè¿‡åœç”¨EffectScopeæ¥åœæ­¢å…¶ä¸­æ‰€æœ‰å‰¯ä½œç”¨çš„æ‰§è¡Œã€‚è¿™æœ‰åŠ©äºé¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œç›‘å¬ï¼Œä»è€ŒèŠ‚çœèµ„æºï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚ç»„ä»¶å¸è½½æ—¶ï¼Œç›¸å…³çš„å“åº”å¼å‰¯ä½œç”¨å¦‚æœä¸è¢«é€‚å½“åœæ­¢å’Œæ¸…ç†ï¼Œå¯èƒ½ä¼šå› ä¸ºé—­åŒ…ç­‰åŸå› æŒç»­å ç”¨å†…å­˜ã€‚

é€šè¿‡EffectScopeçš„åœç”¨æ“ä½œï¼Œå¯ä»¥ç¡®ä¿è¿™äº›å‰¯ä½œç”¨è¢«æ­£ç¡®æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚EffectScopeå…è®¸å¼€å‘è€…åœ¨æ›´ç»†ç²’åº¦ä¸Šç®¡ç†å‰¯ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ä¸´æ—¶åœç”¨æŸä¸ªEffectScopeï¼Œè€Œä¸å½±å“å…¶ä»–å‰¯ä½œç”¨çš„æ‰§è¡Œã€‚è¿™åœ¨å¤„ç†å¤æ‚çš„å“åº”å¼é€»è¾‘æ—¶éå¸¸æœ‰ç”¨ã€‚

## `pause` æš‚åœçŠ¶æ€

> ğŸ’¡ æš‚åœå’Œæ¢å¤EffectScopeï¼Œæš‚åœåçš„Scopeä¸ä¼šæ‰§è¡Œå‰¯ä½œç”¨ã€‚

**`pause`** å’Œ **`resume`** æ–¹æ³•ç”¨äºæš‚åœå’Œæ¢å¤EffectScopeï¼Œæš‚åœåçš„Scopeä¸ä¼šæ‰§è¡Œå‰¯ä½œç”¨ã€‚è¿™å¯¹äºä¸€äº›ç‰¹æ®Šåœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚åœ¨æŸäº›æƒ…å†µä¸‹æš‚æ—¶ç¦ç”¨æŸä¸ªå‰¯ä½œç”¨ï¼Œæˆ–è€…åœ¨ç»„ä»¶å¸è½½æ—¶æš‚åœæ‰€æœ‰å‰¯ä½œç”¨çš„æ‰§è¡Œã€‚

é€šè¿‡æš‚åœEffectScopeï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œç›‘å¬ï¼ŒèŠ‚çœèµ„æºï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚æš‚åœåçš„EffectScopeä¸ä¼šæ‰§è¡Œå…¶ä¸­çš„å‰¯ä½œç”¨ï¼Œç›´åˆ°æ¢å¤ä¸ºæ­¢ã€‚è¿™ç§æœºåˆ¶å…è®¸å¼€å‘è€…åœ¨éœ€è¦çš„æ—¶å€™æš‚åœå’Œæ¢å¤å‰¯ä½œç”¨ï¼Œä»è€Œæ›´çµæ´»åœ°æ§åˆ¶å‰¯ä½œç”¨çš„æ‰§è¡Œã€‚

## **`on`ã€`off`ã€`pause`ã€`resume`ã€`run`ã€`stop`** ç”Ÿå‘½å‘¨æœŸæ§åˆ¶

> ğŸ’¡ åœ¨å½“å‰æ¿€æ´»çš„ **`EffectScope`** ä¸­å®‰å…¨åœ°æ‰§è¡Œä¸€ä¸ªå‡½æ•° **`fn`**ï¼ŒåŒæ—¶ç¡®ä¿å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼Œ**`this`** æ‰€ä»£è¡¨çš„ **`EffectScope`** æˆä¸ºå½“å‰æ¿€æ´»çš„ä½œç”¨åŸŸã€‚

![æˆªå±2024-03-19 15.39.27.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6646e03773d4226ac7e1a2233f95202~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=958&h=578&s=242451&e=png&b=fbfafa)

- **`on`** å’Œ **`off`** æ–¹æ³•åˆ†åˆ«ç”¨äºæ¿€æ´»å’Œåœæ­¢EffectScopeï¼Œæ”¹å˜å½“å‰æ¿€æ´»çš„Scopeã€‚
- **`pause`** å’Œ **`resume`** æ–¹æ³•ç”¨äºæš‚åœå’Œæ¢å¤EffectScopeï¼Œæš‚åœåçš„Scopeä¸ä¼šæ‰§è¡Œå‰¯ä½œç”¨ã€‚
- **`run`**ï¼šåœ¨å½“å‰æ¿€æ´»çš„ **`EffectScope`** ä¸­å®‰å…¨åœ°æ‰§è¡Œä¸€ä¸ªå‡½æ•° **`fn`**ï¼ŒåŒæ—¶ç¡®ä¿å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼Œ**`this`** æ‰€ä»£è¡¨çš„ **`EffectScope`** æˆä¸ºå½“å‰æ¿€æ´»çš„ä½œç”¨åŸŸã€‚
- **`stop`**ï¼šåœæ­¢ **`EffectScope`** åŠå…¶æ‰€æœ‰çš„å‰¯ä½œç”¨ï¼ˆeffectsï¼‰ï¼Œæ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„æ¸…ç†ï¼ˆcleanupï¼‰å‡½æ•°ï¼Œå¹¶é€’å½’åœ°åœæ­¢æ‰€æœ‰å­ä½œç”¨åŸŸï¼ˆscopesï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦åœ¨éœ€è¦åœç”¨æŸä¸ªä½œç”¨åŸŸæ—¶ä½¿ç”¨ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªVueç»„ä»¶å¸è½½æ—¶ï¼Œå¯ä»¥é€šè¿‡åœç”¨ä¸ä¹‹å…³è”çš„ä½œç”¨åŸŸæ¥é˜²æ­¢å†…å­˜æ³„éœ²ã€‚
  - **åœæ­¢æ‰€æœ‰å‰¯ä½œç”¨ã€æ‰§è¡Œæ¸…ç†å‡½æ•°ã€é€’å½’åœæ­¢å­ä½œç”¨åŸŸ**
  - **ä½œç”¨åŸŸç§»é™¤**ï¼šå¦‚æœå½“å‰ä½œç”¨åŸŸä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ï¼ˆdetachedï¼‰ä½œç”¨åŸŸï¼Œå¹¶ä¸”æœ‰çˆ¶ä½œç”¨åŸŸï¼ˆ**`this.parent`**å­˜åœ¨ï¼‰ï¼Œä¸”è¿™æ¬¡åœæ­¢æ“ä½œä¸æ˜¯ç”±çˆ¶ä½œç”¨åŸŸå‘èµ·çš„ï¼ˆ**`!fromParent`**ï¼‰ï¼Œåˆ™éœ€è¦ä»çˆ¶ä½œç”¨åŸŸçš„ **`scopes`** æ•°ç»„ä¸­ç§»é™¤å½“å‰ä½œç”¨åŸŸï¼Œä»¥é¿å…å†…å­˜æ³„éœ²ã€‚

**ä¼˜åŒ–çš„ç§»é™¤æ–¹æ³•ï¼ˆæ—¶é—´å¤æ‚åº¦ O(1)ï¼‰ï¼šå°†çˆ¶ä½œç”¨åŸŸçš„`scopes`æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ å¼¹å‡ºï¼Œå¦‚æœå¼¹å‡ºçš„ä¸æ˜¯å½“å‰ä½œç”¨åŸŸï¼Œåˆ™å°†å®ƒæ”¾åˆ°å½“å‰ä½œç”¨åŸŸåœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œ** è¿™æ ·å¯ä»¥ä¿æŒæ•°ç»„çš„è¿ç»­æ€§å¹¶ä¸”é¿å…éå†æ•´ä¸ªæ•°ç»„æ¥æŸ¥æ‰¾å¹¶ç§»é™¤å½“å‰ä½œç”¨åŸŸã€‚

![æˆªå±2024-03-19 15.49.20.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6eadff93a27544c298ac3847e08a363f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1138&h=418&s=63517&e=png&b=fdfcfc)

- [æºç åœ°å€](https://github.com/vuejs/core/blob/main/packages/reactivity/src/effectScope.ts#L2)
- [RFC](https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md)
